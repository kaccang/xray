#!/bin/bash

CONFIG="/etc/xray/config.json"
clear

# Ambil user & exp tanpa duplikat
mapfile -t entries < <(grep -E '^#& ' "$CONFIG" | awk '!seen[$2]++')

echo ""
echo "╔══════════════════════════════╗"
echo "║        MENU CEK VLESS        ║"
echo "╚══════════════════════════════╝"

# Tampilkan daftar user
for i in "${!entries[@]}"; do
  user=$(echo "${entries[$i]}" | awk '{print $2}')
  printf "  %2d. %s\n" $((i+1)) "$user"
done

echo ""
read -p ">> Pilih nomor akun [1 - ${#entries[@]}]: " num

# Validasi input
if [[ "$num" -lt 1 || "$num" -gt "${#entries[@]}" ]]; then
  echo "Nomor tidak valid!"
  exit 1
fi

# Ambil user & exp
line="${entries[$((num-1))]}"
user=$(echo "$line" | awk '{print $2}')
exp=$(echo "$line" | awk '{print $3}')

# ===========================
# FIX UUID EXTRACTION VLESS
# ===========================
uuid=$(awk -v u="$user" '
$0 ~ "^#& "u" " {found=1; next}
found && /"id":/ {
    match($0, /"id": *"([^"]+)"/, a)
    print a[1]
    exit
}' "$CONFIG")

domain=$(cat /etc/xray/domain)

# ===========================
# VLESS URI (NO BASE64)
# ===========================
vlesslink1="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&type=ws#${user}"
vlesslink2="vless://${uuid}@${domain}:80?path=/vless&encryption=none&type=ws#${user}"

clear

echo -e "───────────────────"
echo -e "     XRAY VLESS ACCOUNT"
echo -e "───────────────────"
echo -e "Remarks     : $user"
echo -e "Domain      : $domain"
echo -e "Port TLS    : 443"
echo -e "Port NTLS   : 80"
echo -e "Encryption  : none"
echo -e "Network     : ws"
echo -e "Path        : /vless"
echo -e "Expired On  : $exp"
echo -e "───────────────────"
echo -e "TLS Link:"
echo -e "$vlesslink1"
echo -e "───────────────────"
echo -e "Non-TLS Link:"
echo -e "$vlesslink2"
echo -e "───────────────────"

read -n 1 -s -r -p "Press any key to back on menu"
menu