#!/bin/bash
# ==========================================
# Colors
RED='\u001B[0;31m'
NC='\u001B[0m'
GREEN='\u001B[0;32m'
BLUE='\u001B[0;34m'
CYAN='\u001B[0;36m'
YELLOW='\u001B[1;33m'
WHITE='\u001B[1;37m'
# ==========================================

clear

# ==========================================
# 1. Cek Status Service
# ==========================================
stat_nginx=$(systemctl is-active nginx)
if [[ $stat_nginx == "active" ]]; then
    status_n="${GREEN}RUNNING${NC}"
else
    status_n="${RED}STOPPED${NC}"
fi

stat_xray=$(systemctl is-active xray)
if [[ $stat_xray == "active" ]]; then
    status_x="${GREEN}RUNNING${NC}"
else
    status_x="${RED}STOPPED${NC}"
fi

# ==========================================
# 2. Cek Kuota (Daily & Monthly)
# ==========================================
if command -v vnstat &> /dev/null; then
    _ONELINE=$(vnstat --oneline 2>/dev/null)
    if [ -n "$_ONELINE" ]; then
        D_RX=$(echo "$_ONELINE" | awk -F ';' '{print $4}' | sed 's/ //g')
        D_TX=$(echo "$_ONELINE" | awk -F ';' '{print $5}' | sed 's/ //g')
        M_RX=$(echo "$_ONELINE" | awk -F ';' '{print $9}' | sed 's/ //g')
        M_TX=$(echo "$_ONELINE" | awk -F ';' '{print $10}' | sed 's/ //g')
    else
        D_RX="0MB"; D_TX="0MB"; M_RX="0MB"; M_TX="0MB"
    fi
else
    D_RX="N/A"; D_TX="N/A"; M_RX="N/A"; M_TX="N/A"
fi

# ==========================================
# 3. Cek Status Multi-VPS (Validasi SSH Login)
# ==========================================
CONF_SLAVE="/etc/xray/sync_slave.conf"
if [ -s "$CONF_SLAVE" ]; then
    SLAVE_IP=$(cat "$CONF_SLAVE" | head -n1 | awk '{print $1}')
    if [[ -n "$SLAVE_IP" && "$SLAVE_IP" != "none" && "$SLAVE_IP" != "0.0.0.0" ]]; then
        # Tes autentikasi SSH langsung (BatchMode=yes menolak prompt password jika key gagal)
        if ssh -o BatchMode=yes -o ConnectTimeout=2 root@$SLAVE_IP "exit" >/dev/null 2>&1; then
            status_slave="${GREEN}CONNECTED${NC}"
        else
            status_slave="${RED}DISCONNECTED (Auth/Timeout)${NC}"
        fi
    else
        status_slave="${CYAN}STANDBY (Unconfigured)${NC}"
    fi
else
    status_slave="${CYAN}STANDBY (Unconfigured)${NC}"
fi

# ==========================================
# 4. Hitung Jumlah Akun XRay
# ==========================================
VMESS_COUNT=$(grep -c '^### ' /etc/xray/config.json 2>/dev/null || echo "0")
VLESS_COUNT=$(grep -c '^#& ' /etc/xray/config.json 2>/dev/null || echo "0")
TROJAN_COUNT=$(grep -c '^#! ' /etc/xray/config.json 2>/dev/null || echo "0")

# ==========================================
# Tampilan Menu Utama
# ==========================================
echo -e "${BLUE}┌──────────────────────────────────────────────┐${NC}"
echo -e "${BLUE}│${NC}            ${CYAN}XRAY VPN SERVER MENU${NC}              ${BLUE}│${NC}"
echo -e "${BLUE}└──────────────────────────────────────────────┘${NC}"
echo -e " Traffic Daily  : ↓ $D_RX | ↑ $D_TX"
echo -e " Traffic Month  : ↓ $M_RX | ↑ $M_TX"
echo -e " Nginx Service  : $status_n"
echo -e " XRay Service   : $status_x"
echo -e " VPS Slave Sync : $status_slave"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "            ${WHITE}XRAY ACCOUNT STATUS${NC}             "
printf "  VMess: ${GREEN}%-3s${NC} | VLess: ${YELLOW}%-3s${NC} | Trojan: ${CYAN}%-3s${NC} 
" "$VMESS_COUNT" "$VLESS_COUNT" "$TROJAN_COUNT"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e " ${CYAN}[ VMESS MENU ]${NC}"
echo -e "  ${YELLOW}[1]${NC} Create VMess Account"
echo -e "  ${YELLOW}[2]${NC} Delete VMess Account"
echo -e "  ${YELLOW}[3]${NC} Renew VMess Account"
echo -e "  ${YELLOW}[4]${NC} Check VMess Login"
echo -e ""
echo -e " ${CYAN}[ VLESS MENU ]${NC}"
echo -e "  ${YELLOW}[5]${NC} Create VLess Account"
echo -e "  ${YELLOW}[6]${NC} Delete VLess Account"
echo -e "  ${YELLOW}[7]${NC} Renew VLess Account"
echo -e "  ${YELLOW}[8]${NC} Check VLess Login"
echo -e ""
echo -e " ${CYAN}[ TROJAN MENU ]${NC}"
echo -e "  ${YELLOW}[9]${NC} Create Trojan Account"
echo -e " ${YELLOW}[10]${NC} Delete Trojan Account"
echo -e " ${YELLOW}[11]${NC} Renew Trojan Account"
echo -e " ${YELLOW}[12]${NC} Check Trojan Login"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e " ${CYAN}[ SYSTEM SETTINGS ]${NC}"
echo -e " ${YELLOW}[13]${NC} Renew Domain Certificate"
echo -e " ${YELLOW}[14]${NC} Restart Nginx & XRay Services"
echo -e " ${YELLOW}[15]${NC} Reboot VPS"
echo -e "  ${RED}[0]${NC} Exit Menu"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

read -p " Select menu [0-15] : " opt

case $opt in
    1) clear ; add-ws ;;
    2) clear ; del-ws ;;
    3) clear ; renew-ws ;;
    4) clear ; cek-ws ;;
    
    5) clear ; add-vless ;;
    6) clear ; del-vless ;;
    7) clear ; renew-vless ;;
    8) clear ; cek-vless ;;
    
    9) clear ; add-tr ;;
    10) clear ; del-tr ;;
    11) clear ; renew-tr ;;
    12) clear ; cek-tr ;;
    
    13) clear ; cert ;; 
    
    14) 
        clear
        echo -e "${GREEN}Restarting Nginx...${NC}"
        systemctl restart nginx
        echo -e "${GREEN}Restarting XRay...${NC}"
        systemctl restart xray
        echo -e "${GREEN}Services Restarted Successfully!${NC}"
        sleep 2
        menu
        ;;
    15) 
        clear
        echo -e "${RED}Rebooting VPS...${NC}"
        sleep 1
        reboot
        ;;
    0) 
        clear
        exit 0 
        ;;
    *)
        echo -e "${RED}Invalid input! Please select a valid number.${NC}"
        sleep 1
        menu
        ;;
esac