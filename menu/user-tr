#!/bin/bash

CONFIG="/etc/xray/config.json"
clear

# Ambil user & exp tanpa duplikat
mapfile -t entries < <(grep -E '^#! ' "$CONFIG" | awk '!seen[$2]++')

echo ""
echo "╔══════════════════════════════╗"
echo "║       MENU CEK TROJAN        ║"
echo "╚══════════════════════════════╝"

# Tampilkan daftar user
for i in "${!entries[@]}"; do
  user=$(echo "${entries[$i]}" | awk '{print $2}')
  printf "  %2d. %s\n" $((i+1)) "$user"
done

echo ""
read -p ">> Pilih nomor akun [1 - ${#entries[@]}]: " num

# Validasi input
if [[ "$num" -lt 1 || "$num" -gt "${#entries[@]}" ]]; then
  echo "Nomor tidak valid!"
  exit 1
fi

# Ambil user & exp
line="${entries[$((num-1))]}"
user=$(echo "$line" | awk '{print $2}')
exp=$(echo "$line" | awk '{print $3}')

# ===========================
# FIX PASSWORD EXTRACTION
# ===========================
uuid=$(awk -v u="$user" '
$0 ~ "^#! "u" " {found=1; next}
found && /"password":/ {
    match($0, /"password": *"([^"]+)"/, a)
    print a[1]
    exit
}' "$CONFIG")

domain=$(cat /etc/xray/domain)

# ===========================
# TROJAN URI
# ===========================
trojanlink="trojan://${uuid}@${domain}:443?path=%2Ftrojan-ws&security=tls&host=${domain}&type=ws&sni=${domain}#${user}"
trojanlink2="trojan://${uuid}@${domain}:80?path=%2Ftrojan-ws&security=none&host=${domain}&type=ws#${user}"

clear

echo -e "───────────────────"
echo -e "     XRAY TROJAN ACCOUNT"
echo -e "───────────────────"
echo -e "Remarks     : $user"
echo -e "Domain      : $domain"
echo -e "Port TLS    : 443"
echo -e "Port NTLS   : 80"
echo -e "Network     : ws"
echo -e "Path        : /trojan-ws"
echo -e "Expired On  : $exp"
echo -e "───────────────────"
echo -e "TLS Link:"
echo -e "$trojanlink"
echo -e "───────────────────"
echo -e "Non-TLS Link:"
echo -e "$trojanlink2"
echo -e "───────────────────"

read -n 1 -s -r -p "Press any key to back on menu"
menu